#!/bin/bash

# Invite API Server Control Script
# Usage: ./invite-server.sh start [port]
#        ./invite-server.sh stop
#        ./invite-server.sh status
#        ./invite-server.sh restart [port]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVER_FILE="$SCRIPT_DIR/server.js"
APP_NAME="attach-api-server"
DEFAULT_PORT=2083

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if PM2 is installed
check_pm2() {
    if ! command -v pm2 &> /dev/null; then
        print_error "PM2 is not installed. Installing PM2..."
        npm install -g pm2
        if [ $? -ne 0 ]; then
            print_error "Failed to install PM2. Please install it manually:"
            print_error "npm install -g pm2"
            exit 1
        fi
        print_success "PM2 installed successfully"
    fi
}

# Check if server.js exists
check_server_file() {
    if [ ! -f "$SERVER_FILE" ]; then
        print_error "Server file not found: $SERVER_FILE"
        print_error "Make sure server.js is in the same directory as this script"
        exit 1
    fi
}

# Get server status
get_status() {
    pm2 describe "$APP_NAME" &> /dev/null
    return $?
}

# Start the server
start_server() {
    local port=${1:-$DEFAULT_PORT}
    
    print_info "Checking if server is already running..."
    
    if get_status; then
        print_warning "Server is already running!"
        pm2 describe "$APP_NAME"
        return 0
    fi
    
    print_info "Starting Invite API Server on port $port..."
    
    # Start the server with PM2
    pm2 start "$SERVER_FILE" --name "$APP_NAME" -- "$port"
    
    if [ $? -eq 0 ]; then
        print_success "Server started successfully on port $port"
        print_info "Process name: $APP_NAME"
        print_info "Use 'pm2 logs $APP_NAME' to view logs"
        print_info "Use 'pm2 monit' to monitor the process"
    else
        print_error "Failed to start server"
        exit 1
    fi
}

# Stop the server
stop_server() {
    print_info "Checking if server is running..."
    
    if ! get_status; then
        print_warning "Server is not running"
        return 0
    fi
    
    print_info "Stopping Invite API Server..."
    
    pm2 stop "$APP_NAME"
    pm2 delete "$APP_NAME"
    
    if [ $? -eq 0 ]; then
        print_success "Server stopped successfully"
    else
        print_error "Failed to stop server"
        exit 1
    fi
}

# Show server status
show_status() {
    if get_status; then
        print_success "Server is running"
        pm2 describe "$APP_NAME"
        echo ""
        print_info "Recent logs:"
        pm2 logs "$APP_NAME" --lines 10
    else
        print_warning "Server is not running"
    fi
}

# Restart the server
restart_server() {
    local port=${1:-$DEFAULT_PORT}
    
    print_info "Restarting Invite API Server..."
    
    if get_status; then
        stop_server
        sleep 2
    fi
    
    start_server "$port"
}

# Show usage information
show_usage() {
    echo "Usage: $0 {start|stop|restart|status} [port]"
    echo ""
    echo "Commands:"
    echo "  start [port]   Start the server (default port: $DEFAULT_PORT)"
    echo "  stop           Stop the server"
    echo "  restart [port] Restart the server"
    echo "  status         Show server status"
    echo ""
    echo "Examples:"
    echo "  $0 start       # Start on default port ($DEFAULT_PORT)"
    echo "  $0 start 3000  # Start on port 3000"
    echo "  $0 stop        # Stop the server"
    echo "  $0 status      # Check if server is running"
    echo ""
    echo "Additional PM2 commands:"
    echo "  pm2 logs $APP_NAME      # View real-time logs"
    echo "  pm2 monit               # Monitor all PM2 processes"
    echo "  pm2 restart $APP_NAME   # Quick restart"
}

# Main script logic
main() {
    check_pm2
    check_server_file
    
    case "$1" in
        start)
            start_server "$2"
            ;;
        stop)
            stop_server
            ;;
        restart)
            restart_server "$2"
            ;;
        status)
            show_status
            ;;
        *)
            show_usage
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"

